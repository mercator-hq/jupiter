# Mercator Jupiter - Secret Management Example Configuration
#
# This configuration demonstrates how to use the secret management framework
# to securely load API keys and other sensitive credentials from multiple sources.

# Proxy server configuration
proxy:
  listen_address: "127.0.0.1:8080"
  read_timeout: "30s"
  write_timeout: "30s"

# Security configuration
security:
  # TLS configuration (optional)
  tls:
    enabled: false

  # Secret management configuration
  secrets:
    # List of secret providers (tried in order)
    providers:
      # Environment variables (highest priority)
      - type: "env"
        enabled: true
        prefix: "MERCATOR_SECRET_"

      # File-based secrets (Kubernetes-style)
      - type: "file"
        enabled: true
        path: "/var/secrets"
        watch: true  # Auto-reload on file changes

      # AWS KMS (Phase 2 - stubbed for MVP)
      - type: "aws_kms"
        enabled: false
        region: "us-west-2"
        key_id: "arn:aws:kms:us-west-2:123456789:key/abcd-1234"

      # GCP KMS (Phase 2 - stubbed for MVP)
      - type: "gcp_kms"
        enabled: false
        project: "my-project"
        location: "global"
        keyring: "mercator"
        key: "secrets-key"

      # HashiCorp Vault (Phase 2 - stubbed for MVP)
      - type: "vault"
        enabled: false
        address: "https://vault.example.com:8200"
        token: "${VAULT_TOKEN}"
        vault_path: "secret/mercator"

    # Secret caching configuration
    cache:
      enabled: true
      ttl: "5m"       # Cache secrets for 5 minutes
      max_size: 1000  # Maximum 1000 cached secrets

# Provider configuration using secret references
providers:
  # OpenAI provider
  openai:
    base_url: "https://api.openai.com/v1"
    api_key: "${secret:openai-api-key}"  # Resolved from secret providers
    timeout: "30s"
    max_retries: 3

  # Anthropic provider
  anthropic:
    base_url: "https://api.anthropic.com"
    api_key: "${secret:anthropic-api-key}"  # Resolved from secret providers
    timeout: "30s"
    max_retries: 3

  # Custom provider
  custom:
    base_url: "https://api.custom.com"
    api_key: "${secret:custom-api-key}"
    timeout: "30s"

# Policy engine configuration
policy:
  mode: "file"
  policy_file: "policies/example.yaml"
  watch_enabled: false
  validation_enabled: true

# Evidence storage configuration
evidence:
  backend: "sqlite"
  sqlite:
    database_path: "evidence.db"

# Telemetry configuration
telemetry:
  logging:
    level: "info"
    format: "json"

---
# How to Use Secret Management
# ==============================

# 1. Environment Variables (Highest Priority)
#
#    Set environment variables with the configured prefix:
#
#    export MERCATOR_SECRET_OPENAI_API_KEY="sk-abc123..."
#    export MERCATOR_SECRET_ANTHROPIC_API_KEY="sk-ant-xyz789..."
#
#    Secret name conversion:
#      - "openai-api-key" → "MERCATOR_SECRET_OPENAI_API_KEY"
#      - Lowercase → uppercase
#      - Hyphens → underscores
#      - Add configured prefix

# 2. File-Based Secrets (Kubernetes-style)
#
#    Create individual files for each secret:
#
#    mkdir -p /var/secrets
#    echo "sk-abc123..." > /var/secrets/openai-api-key
#    chmod 0600 /var/secrets/openai-api-key
#
#    Important:
#      - File permissions MUST be 0600 or 0400
#      - One secret per file
#      - Filename is the secret name
#      - Watch mode enables auto-reload on file changes

# 3. Kubernetes Secrets
#
#    Mount Kubernetes secrets as files:
#
#    apiVersion: v1
#    kind: Secret
#    metadata:
#      name: mercator-secrets
#    type: Opaque
#    stringData:
#      openai-api-key: "sk-abc123..."
#      anthropic-api-key: "sk-ant-xyz789..."
#    ---
#    apiVersion: v1
#    kind: Pod
#    spec:
#      containers:
#      - name: mercator
#        volumeMounts:
#        - name: secrets
#          mountPath: /var/secrets
#          readOnly: true
#      volumes:
#      - name: secrets
#        secret:
#          secretName: mercator-secrets
#          defaultMode: 0400

# 4. Secret References in Configuration
#
#    Use ${secret:name} syntax in any configuration value:
#
#    providers:
#      openai:
#        api_key: "${secret:openai-api-key}"
#
#    The secret manager will:
#      1. Parse the reference
#      2. Try each provider in order
#      3. Return the first successful value
#      4. Cache the result
#      5. Replace the reference with the actual value

# 5. Provider Priority
#
#    Secrets are resolved with the following priority:
#      1. Environment variables (fastest, highest priority)
#      2. File-based secrets (Kubernetes, Docker secrets)
#      3. AWS KMS (Phase 2)
#      4. GCP KMS (Phase 2)
#      5. HashiCorp Vault (Phase 2)
#
#    The first provider that returns a value wins.

# 6. Secret Caching
#
#    Secrets are cached in memory to reduce backend calls:
#      - TTL: 5 minutes (configurable)
#      - Max size: 1000 secrets (configurable)
#      - LRU eviction when full
#      - Automatic invalidation on provider refresh

# 7. Secret Rotation
#
#    For zero-downtime secret rotation:
#
#    a) File-based provider with watch mode:
#       - Update secret file
#       - Provider automatically detects change
#       - Cache is cleared
#       - New value loaded on next request
#
#    b) Manual refresh (for environment variables):
#       - Update environment variable
#       - Send SIGHUP to Mercator (if implemented)
#       - Or restart Mercator

# 8. Security Best Practices
#
#    ✓ Use environment variables for development
#    ✓ Use file-based secrets for production (Kubernetes)
#    ✓ Use KMS/Vault for highly sensitive data (Phase 2)
#    ✓ Enable caching to reduce backend load
#    ✓ Set appropriate TTL based on rotation frequency
#    ✓ Use file watching for zero-downtime rotation
#    ✓ Never commit secrets to version control
#    ✓ Validate file permissions (0600 or 0400 only)
#    ✓ Rotate secrets regularly (90 days recommended)
#
#    ✗ Don't use world-readable permissions
#    ✗ Don't log secret values
#    ✗ Don't commit .env files
#    ✗ Don't use the same secret across environments

# 9. Troubleshooting
#
#    If secret resolution fails:
#      1. Check logs for "secret cache miss" messages
#      2. Verify environment variable naming (uppercase, underscores)
#      3. Verify file permissions (0600 or 0400 only)
#      4. Check file path is correct
#      5. Verify provider order (higher priority first)
#      6. Check cache TTL hasn't expired
#
#    Debug logging:
#      Set log level to "debug" to see secret resolution details
#      (secret values are never logged, only redacted names)

# 10. Example Development Setup
#
#     # .env file (DO NOT COMMIT)
#     export MERCATOR_SECRET_OPENAI_API_KEY="sk-..."
#     export MERCATOR_SECRET_ANTHROPIC_API_KEY="sk-ant-..."
#
#     # Load environment
#     source .env
#
#     # Start Mercator
#     ./mercator start --config config.yaml

# 11. Example Production Setup (Kubernetes)
#
#     # Create secret
#     kubectl create secret generic mercator-secrets \
#       --from-literal=openai-api-key="sk-..." \
#       --from-literal=anthropic-api-key="sk-ant-..."
#
#     # Deploy Mercator
#     kubectl apply -f mercator-deployment.yaml
#
#     # Secrets are automatically mounted to /var/secrets
#     # File provider watches for changes
#     # Zero-downtime rotation supported

# 12. Example Production Setup (AWS)
#
#     # Store secrets in AWS Secrets Manager
#     aws secretsmanager create-secret \
#       --name mercator/openai-api-key \
#       --secret-string "sk-..."
#
#     # Phase 2: Enable AWS KMS provider
#     # Mercator retrieves secrets using IAM role
#     # No credentials in configuration
